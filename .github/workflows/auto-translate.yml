name: Auto Translate (Push to New Branch)

on:
  push:
    branches-ignore:
      - main
    # ä»…ç›‘å¬ changelog ç›®å½•/ç¿»è¯‘è„šæœ¬å˜æ›´ï¼Œé¿å…æ— æ„ä¹‰è§¦å‘
    paths:
      - 'changelog/**'
      - 'translate.js'

jobs:
  translate:
    if: "!contains(github.ref_name, 'auto-translate')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read # å¯é€‰ï¼Œè‹¥åç»­è¦è‡ªåŠ¨æPRå¯åŠ 

    steps:
      # 1ï¸âƒ£ æ£€å‡ºè§¦å‘çš„æºåˆ†æ”¯ï¼ˆä¼˜åŒ–ï¼šæ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…åˆ†æ”¯åˆ›å»ºé—®é¢˜ï¼‰
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0 # æ‹‰å–å®Œæ•´æäº¤å†å²ï¼Œç¡®ä¿åˆ†æ”¯åˆ›å»ºæ­£å¸¸

      # 2ï¸âƒ£ Node ç¯å¢ƒï¼ˆä¼˜åŒ–ï¼šç¼“å­˜ä¾èµ–ï¼ŒåŠ é€Ÿå®‰è£…ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # ç¼“å­˜node_modulesï¼Œåç»­è¿è¡Œæ›´å¿«
          cache-dependency-path: './package-lock.json' # ç²¾å‡†ç¼“å­˜

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šé¿å…è¦†ç›–ç°æœ‰package.jsonï¼‰
      - name: Install dependencies
        run: |
          # ä»…å½“package.jsonä¸å­˜åœ¨æ—¶åˆå§‹åŒ–ï¼Œé˜²æ­¢è¦†ç›–å·²æœ‰é…ç½®
          if [ ! -f "package.json" ]; then
            npm init -y
          fi
          # å®‰è£…ä¾èµ–ï¼ˆä¼˜å…ˆç”¨package-lock.jsoné”å®šç‰ˆæœ¬ï¼‰
          npm install openai fs-extra
        # å¤±è´¥æ—¶é‡è¯•ï¼Œæå‡ç¨³å®šæ€§
        continue-on-error: false
        retry:
          max_attempts: 2
          delay_seconds: 10

      # 4ï¸âƒ£ å‰ç½®æ£€æŸ¥ï¼šç¡®è®¤ç¿»è¯‘è„šæœ¬å­˜åœ¨
      - name: Check translation script exists
        run: |
          if [ ! -f "translate.js" ]; then
            echo "âŒ ç¿»è¯‘è„šæœ¬ translate.js ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          echo "âœ… ç¿»è¯‘è„šæœ¬å­˜åœ¨ï¼Œå¼€å§‹æ‰§è¡Œç¿»è¯‘"

      # 5ï¸âƒ£ æ‰§è¡Œç¿»è¯‘ï¼ˆä¼˜åŒ–ï¼šå¢åŠ æ—¥å¿—ã€å»¶é•¿è¶…æ—¶ï¼Œæ•è·é”™è¯¯ï¼‰
      - name: Run translation script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NODE_ENV: production # ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
        run: |
          # æ‰“å°ç¯å¢ƒä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "Nodeç‰ˆæœ¬: $(node -v)"
          echo "NPMç‰ˆæœ¬: $(npm -v)"
          # æ‰§è¡Œè„šæœ¬å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
          node translate.js 2>&1 | tee translation.log
        timeout-minutes: 60
        # ç¿»è¯‘å¤±è´¥æ—¶ç»ˆæ­¢æµç¨‹ï¼ˆé¿å…æ¨é€ç©ºåˆ†æ”¯ï¼‰
        continue-on-error: false

      # 6ï¸âƒ£ åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ç¿»è¯‘åˆ†æ”¯å¹¶æ¨é€ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šå¥å£®æ€§ï¼‰
      - name: Push translated files to new branch
        run: |
          # ç”ŸæˆUTCæ—¶é—´æˆ³ï¼ˆé¿å…æ—¶åŒºé—®é¢˜ï¼‰
          TS=$(date -u '+%Y%m%d-%H%M%S')
          SRC_BRANCH="${GITHUB_REF_NAME}"
          # æ¸…ç†åˆ†æ”¯åç‰¹æ®Šå­—ç¬¦ï¼ˆé¿å…éæ³•åˆ†æ”¯åï¼‰
          TRANS_BRANCH=$(echo "${SRC_BRANCH}-auto-translate-${TS}" | sed -e 's/[^a-zA-Z0-9_\-]/-/g')

          # é…ç½®Gitç”¨æˆ·ï¼ˆå¿…é€‰ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ‡æ¢å¹¶åˆ›å»ºæ–°åˆ†æ”¯
          git checkout -b "$TRANS_BRANCH"

          # ç¡®ä¿ç¿»è¯‘ç›®å½•å­˜åœ¨ï¼ˆé˜²æ­¢git addæŠ¥é”™ï¼‰
          mkdir -p cn/changelog ko/changelog

          # ä»…æ·»åŠ ç¿»è¯‘ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆç²¾å‡†æ§åˆ¶ï¼Œé¿å…å¤šä½™æäº¤ï¼‰
          git add \
            cn/changelog/*.md \
            cn/changelog/*.mdx \
            ko/changelog/*.md \
            ko/changelog/*.mdx

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆæ— å˜æ›´åˆ™è·³è¿‡æäº¤ï¼‰
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— ç¿»è¯‘æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            # åˆ é™¤ç©ºåˆ†æ”¯ï¼ˆé¿å…åƒåœ¾åˆ†æ”¯ï¼‰
            git checkout "$SRC_BRANCH"
            git branch -D "$TRANS_BRANCH"
            exit 0
          fi

          # æäº¤å˜æ›´ï¼ˆå¸¦è¯¦ç»†ä¿¡æ¯ï¼‰
          git commit -m "chore: auto translate changelog (${TS})
          - Source branch: ${SRC_BRANCH}
          - Translation time: $(date -u)"

          # æ¨é€æ–°åˆ†æ”¯ï¼ˆå¼ºåˆ¶æ¨é€ä»…ç”¨äºåŒååˆ†æ”¯ï¼Œæ­¤å¤„æ— éœ€ï¼‰
          git push origin "$TRANS_BRANCH"

          # è¾“å‡ºåˆ†æ”¯ä¿¡æ¯ï¼Œæ–¹ä¾¿æŸ¥çœ‹
          echo "âœ… ç¿»è¯‘åˆ†æ”¯å·²æ¨é€ï¼š$TRANS_BRANCH"
          echo "ğŸ”— åˆ†æ”¯åœ°å€ï¼šhttps://github.com/${{ github.repository }}/tree/$TRANS_BRANCH"

      # 7ï¸âƒ£ å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ç¿»è¯‘æµç¨‹å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
          cat translation.log || echo "æ— ç¿»è¯‘æ—¥å¿—"